name: Deploy to Linode Object Storage

on:
  push:
    branches:
      - s3-sync # TODO switch to mainline

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3
        with:
          submodules: 'true'

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.126.1' # hugo-anubis theme uses deprecated fields

      - name: Build Hugo site
        run: hugo

      - name: Install s3cmd
        run: sudo apt-get install s3cmd

      - name: Configure s3cmd
        run: |
          echo "[default]" > ~/.s3cfg
          echo "access_key = ${{ secrets.LINODE_ACCESS_KEY }}" >> ~/.s3cfg
          echo "secret_key = ${{ secrets.LINODE_SECRET_KEY }}" >> ~/.s3cfg
          echo "host_base = us-southeast-1.linodeobjects.com" >> ~/.s3cfg
          echo "host_bucket = ciarandg-portfolio.us-southeast-1.linodeobjects.com" >> ~/.s3cfg
          echo "website_endpoint = https://ciarandg-portfolio.website-us-southeast-1.linodeobjects.com" >> ~/.s3cfg

      - name: Configure website
        run: |
          s3cmd ws-create --ws-index=index.html --ws-error=404.html s3://ciarandg-portfolio

      - name: Sync website to Linode Object Storage
        run: |
          s3cmd sync public/ s3://ciarandg-portfolio --no-mime-magic --guess-mime-type --acl-public --delete-removed --delete-after

      # NOTE: s3cmd does not play nice with CSS MIME types. As a result we have to manually push the CSS directory with a hardcoded MIME type
      - name: Upload CSS to Linode Object Storage
        run: |
          s3cmd rm s3://ciarandg-portfolio/css/ --recursive
          s3cmd put public/css/ s3://ciarandg-portfolio/css/ --mime-type='text/css' --recursive --acl-public
